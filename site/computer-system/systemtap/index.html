
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="开发知识wiki">
      
      
        <meta name="author" content="tink">
      
      
        <link rel="canonical" href="https://docs.cyub.vip/dev-wiki/computer-system/systemtap/">
      
      
        <link rel="prev" href="../command/">
      
      
        <link rel="next" href="../cpu-arch/">
      
      
      <link rel="icon" href="../../favicon.ico">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.4">
    
    
      
        <title>Systemtap - 开发知识wiki</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bd3936ea.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#systemtap" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="开发知识wiki" class="md-header__button md-logo" aria-label="开发知识wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            开发知识wiki
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Systemtap
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  简介

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../io/" class="md-tabs__link">
          
  
  操作系统

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../computer-network/tcp/" class="md-tabs__link">
          
  
  计算机网络

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../database/mysql/%E7%AE%80%E4%BB%8B/" class="md-tabs__link">
          
  
  数据库

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cache/" class="md-tabs__link">
        
  
    
  
  缓存系统

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../container/install/" class="md-tabs__link">
          
  
  容器

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../qa/redis/" class="md-tabs__link">
          
  
  QA

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="开发知识wiki" class="md-nav__button md-logo" aria-label="开发知识wiki" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3 1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>

    </a>
    开发知识wiki
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    简介
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    操作系统
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            操作系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../proc/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    proc文件系统
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../nptl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    NPTL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../command/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常用命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Systemtap
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Systemtap
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    安装
  </a>
  
    <nav class="md-nav" aria-label="安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    交叉检测
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    第一个测试脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    工作原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtap-scripts" class="md-nav__link">
    SystemTap scripts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    事件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtap-functions" class="md-nav__link">
    SystemTap functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#target-variables" class="md-nav__link">
    Target Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtap-scripts_1" class="md-nav__link">
    SystemTap Scripts基本操作
  </a>
  
    <nav class="md-nav" aria-label="SystemTap Scripts基本操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    注释
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ifelsewhilefor" class="md-nav__link">
    if/else/while/for
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    比较操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    字符串
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    元组
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    聚集统计
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-line-arguments" class="md-nav__link">
    Command-Line Arguments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    更多示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    学习资料
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../cpu-arch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CPU架构
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../compiling-linux-kernel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译Linux内核
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    计算机网络
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            计算机网络
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../computer-network/tcp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TCP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../computer-network/http/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HTTP
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    数据库
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            数据库
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    mysql
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            mysql
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mysql/%E7%AE%80%E4%BB%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    概览
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mysql/%E4%BA%8B%E5%8A%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    事务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mysql/%E7%B4%A2%E5%BC%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    索引
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/mysql/FAQ/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Elasticsearch
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Elasticsearch
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/elasticsearch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    概览
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/elasticsearch/memory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存占用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/elasticsearch/performance_tuning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    性能调优
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/elasticsearch/production_configuring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    生产配置参考
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/elasticsearch/doc_values_and_fielddata/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docs value与 field data
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../database/redis/redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Redis
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../cache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    缓存系统
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    容器
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            容器
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../container/install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../container/image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    镜像
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../container/cgroup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cgroup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../container/namespace/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    namespace
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    QA
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            QA
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    redis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mysql
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/tcp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tcp
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/http/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    http
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/cache/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    缓存
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/nginx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nginx
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/queue/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    消息队列
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IO
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/protobuf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    protobuf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/go/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    go
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/dist/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    分布式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/es/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Elasticsearch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/docker/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docker
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../qa/ref/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    参考资料
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    安装
  </a>
  
    <nav class="md-nav" aria-label="安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    交叉检测
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    第一个测试脚本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    工作原理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtap-scripts" class="md-nav__link">
    SystemTap scripts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    事件
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtap-functions" class="md-nav__link">
    SystemTap functions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#target-variables" class="md-nav__link">
    Target Variables
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#systemtap-scripts_1" class="md-nav__link">
    SystemTap Scripts基本操作
  </a>
  
    <nav class="md-nav" aria-label="SystemTap Scripts基本操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    注释
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ifelsewhilefor" class="md-nav__link">
    if/else/while/for
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    比较操作
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    字符串
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    元组
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    聚集统计
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-line-arguments" class="md-nav__link">
    Command-Line Arguments
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    更多示例
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    学习资料
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="systemtap">systemtap</h1>
<p>SystemTap is a tracing and probing tool that allows users to study and monitor the activities of the computer system (particularly, the kernel) in fine detail. It provides information similar to the output of tools like netstat, ps, top, and iostat, but is designed to provide more filtering and analysis options for collected information. </p>
<p>SystemTap 是一种跟踪和探测工具，允许用户详细研究和监视计算机系统（特别是内核）的活动。它提供的信息类似于 netstat、ps、top 和 iostat 等工具的输出，但旨在为收集的信息提供更多过滤和分析选项。</p>
<p>SystemTap 的当前迭代允许在探测各种内核的内核空间事件时有多种选择。然而，SystemTap 探测用户空间事件的能力取决于内核支持（Utrace 机制），这在许多内核中是不可用的。因此，只有某些内核版本支持用户空间探测。</p>
<p>SystemTap 与许多命令行工具一起分发，允许您监视系统的活动。 stap 命令从 SystemTap 脚本中读取探测指令，将这些指令转换为 C 代码，构建内核模块，并将其加载到正在运行的 Linux 内核中。 staprun 命令运行 SystemTap 检测，即在交叉检测期间从 SystemTap 脚本构建的内核模块。</p>
<h2 id="_1">安装</h2>
<p>安装systemtap</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sudo apt-get install -y systemtap systemtap-runtime
</code></pre></div></td></tr></table></div>
<p>Systemtap还需内核相关信息来放置探针，在Red Hat系统里面叫做debug-info，而在ubuntu下叫 debug symbols, 简称dbgsym。这些包我们可以使用<code>stap-prep</code>命令来安装各种依赖，若安装失败，我们可以使用下面脚本来完成：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>

sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>systemtap
sudo<span class="w"> </span>apt-key<span class="w"> </span>adv<span class="w"> </span>--keyserver<span class="w"> </span>keyserver.ubuntu.com<span class="w"> </span>--recv-keys<span class="w"> </span>C8CAB6595FDFF622

<span class="nv">codename</span><span class="o">=</span><span class="k">$(</span>lsb_release<span class="w"> </span>-c<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span><span class="w"> </span><span class="c1"># ubuntu发行版本名称</span>
sudo<span class="w"> </span>tee<span class="w"> </span>/etc/apt/sources.list.d/ddebs.list<span class="w"> </span><span class="s">&lt;&lt; EOF</span>
<span class="s">deb http://ddebs.ubuntu.com/ ${codename} main restricted universe multiverse</span>
<span class="s">deb http://ddebs.ubuntu.com/ ${codename}-updates main restricted universe multiverse</span>
<span class="s">#deb http://ddebs.ubuntu.com/ ${codename}-security main restricted universe multiverse</span>
<span class="s">deb http://ddebs.ubuntu.com/ ${codename}-proposed main restricted universe multiverse</span>
<span class="s">EOF</span>

sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>linux-image-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>-dbgsym
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>linux-headers-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="_2">交叉检测</h3>
<p>在某些情况下公司政策可能会禁止管理员在特定机器上安装提供编译器或调试信息的 RPM 包，从而阻止 SystemTap 的部署。要解决此问题，SystemTap 允许使用交叉检测（cross-instrumentation）。首先我们要明确三个概念：</p>
<ul>
<li>
<p>Instrumentation module（检测模块）</p>
<p>the kernel module built from a SystemTap script. The SystemTap module is built on the host system, and will be loaded on the target kernel of target system.
- Host system</p>
<p>the system on which you compile the instrumentation modules from SystemTap scripts in order to load them on target systems. 主机系统，用于构建检测模块，非生产服务器，可称为编译机。</p>
</li>
<li>
<p>Target system</p>
<p>the system for which you are building the instrumentation modules from SystemTap scripts. 目标系统，用于运行检测模块，也就是每一个我们要诊断的生产服务器。</p>
</li>
<li>
<p>Target kernel</p>
<p>the kernel of the target system. This is the kernel on which you intend to load or run the instrumentation module. 目标系统的内核。</p>
</li>
</ul>
<p>交叉检测流程：</p>
<ol>
<li>在生产服务器安装<code>systemtap-runtime</code>包</li>
<li>通过<code>uname -r</code>命令获取生成服务器的内核版本</li>
<li>
<p>在编译机上面安装SystemTap，并生成检测模块
    &gt; stap -p4 -r kernel_version script -m module_name
    &gt; 示例：stap -r 2.6.18-92.1.10.el5 -e 'probe vfs.read {exit()}' -m simple</p>
</li>
<li>
<p>将检测模块复制到生产服务器上面，然后执行
    &gt; staprun module_name.ko</p>
</li>
</ol>
<h2 id="_3">第一个测试脚本</h2>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>sudo stap -e &#39;probe begin {printf(&quot;hello world\n&quot;); exit()}&#39;
sudo stap -v -e &#39;probe vfs.read {printf(&quot;read performed\n&quot;); exit()}&#39;
sudo stap -e &#39;probe timer.s(4){rintf(&quot;hello world\n&quot;)}&#39;
sudo stap -e &#39;probe syscall.open,syscall.openat { printf (&quot;%s(%d) %s\n&quot;, execname(), pid(), pp())}&#39;
</code></pre></div></td></tr></table></div>
<h2 id="_4">工作原理</h2>
<p>The essential idea behind a SystemTap script is to name events, and to give them handlers. When SystemTap runs the script, SystemTap monitors for the event; once the event occurs, the Linux kernel then runs the handler as a quick sub-routine, then resumes.</p>
<p>There are several kind of events; entering/exiting a function, timer expiration, session termination, etc. A handler is a series of script language statements that specify the work to be done whenever the event occurs. This work normally includes extracting data from the event context, storing them into internal variables, and printing results. </p>
<p><strong>An event and its corresponding handler is collectively called a probe</strong>. A SystemTap script can have multiple probes.</p>
<p><strong>A probe's handler is commonly referred to as a probe body</strong>. </p>
<p>SystemTap 基本思想是命名事件，并为它们提供处理程序。每当发生指定的事件时，内核都会将处理程序视为子例程运行，然后继续运行。有一系列的事件，例如进入或退出函数，计时器到期或整个SystemTap会话的开始和停止。处理程序是一系列脚本语言语句，用于指定事件发生时要完成的工作。这项工作通常包含从事件上下文中提取数据，将其存储到内部变量或打印结果。</p>
<p>SystemTap 的工作原理是将脚本翻译成C语言，执行C编译器创建一个内核模块。当模块被加载后，通过挂载到内核来激活所有的探测事件。然后，当事件发生再任何处理器上时，编译后的处理程序就运行，最终，SystemTap会话停止，Hook取消，内核模块被移除，整个过程由命令行程序stap驱动。</p>
<p><img alt="" src="https://static.cyub.vip/images/202110/systemtap.jpg" /></p>
<h2 id="systemtap-scripts">SystemTap scripts</h2>
<p>SystemTap脚本文件拓展名称是<code>.stp</code>，脚本里面包含的探针(probes)格式如下：</p>
<blockquote>
<p>probe event {statements}</p>
</blockquote>
<p>SystemTap 运行一个探针有多个事件；多个事件由逗号 (,) 分隔。如果在单个探测器中指定了多个事件，则 SystemTap 将在发生任何指定事件时执行处理程序。</p>
<p>每个探针都有一个对应的语句块。此语句块括在大括号 ({ }) 中，包含每个事件要执行的语句。 SystemTap 依次执行这些语句；多个语句之间通常不需要特殊的分隔符或终止符。</p>
<p>SystemTap 允许您编写函数来分解出由许多探测器使用的代码。因此，您无需在多个探针中重复编写相同系列的语句，而只需将指令放在函数中，如下所示：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>function function_name(arguments) {statements}
probe event {function_name(arguments)}
</code></pre></div></td></tr></table></div>
<h2 id="_5">事件</h2>
<ul>
<li>
<p>syscall.system_call</p>
<p>系统调用， 比如syscall.open
- syscall.system_call.return </p>
<p>系统调用返回时，比如syscall.open.return
- vfs.file_operation</p>
<p>Virtual File System (VFS)操作时，比如vfs.read
- vfs.file_operation.return</p>
<p>Virtual File System (VFS)操作返回时，比如vfs.read.return</p>
</li>
<li>
<p>kernel.function("function")</p>
<p>内核函数调用时，即进入内核函数时。我们可以使用通配符*，表示函数。</p>
<ul>
<li>kernel.function("*") 表示所有的内核函数</li>
<li>kernel.function("*@net/socket.c") 表示net/socket.c源文件内的所有内核函数</li>
<li>kernel.function("function").return</li>
</ul>
<p>内核函数调用完成，退出时</p>
</li>
<li>
<p>module("module").function("function")</p>
<p>模块内函数调用时，比如module("ext3").function("*")
- module("module").function("function").return</p>
<p>模块内函数调用完成返回时
- begin</p>
<p>The startup of a SystemTap session，systemptap脚本即将运行
- end</p>
<p>The startup of a SystemTap session</p>
</li>
<li>
<p>timer events</p>
<p>定时器事件。比如每隔4s触发的事件是timer.s(4)
其他定时器事件有：
- timer.ms(milliseconds)
- timer.us(microseconds)
- timer.ns(nanoseconds)
- timer.hz(hertz)
- timer.jiffies(jiffies)
- timer.profile 每个CPU上周期触发的定时器</p>
</li>
<li>
<p>process("a.out").function("foo*")</p>
<p>a.out 中函数名前缀为foo的函数信息
- process("a.out").statement("*@main.c:200")</p>
<p>a.out中文件main.c 200行处的状态</p>
</li>
</ul>
<p>列出进程a.out所有可用探点：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code># vagrant@vagrant:/usr/src/linux-headers-5.4.0-81$ grep -nr &#39;SYSCALL_DEFINE3(open&#39; ./
stap -l &#39;process(&quot;a.out&quot;).function(&quot;*&quot;)&#39;
</code></pre></div></td></tr></table></div>
<h2 id="systemtap-functions">SystemTap functions</h2>
<ul>
<li>tid() 当前线程id</li>
<li>pid() 当前进程id</li>
<li>uid() 当前用户id</li>
<li>execname() 当前进程名称</li>
<li>cpu() 当前cpu编号</li>
<li>gettimeofday_s() 秒时间戳</li>
<li>get_cycles(), 硬件周期计数器快照</li>
<li>pp() 探测点事件名称</li>
<li>ppfunc() 探测点触发的函数名称</li>
<li>print_backtrace() 打印内核栈</li>
<li>print_ubacktrace() 打印用户空间栈</li>
<li>thread_indent() 缩进打印系统调用栈</li>
<li>
<p>target()</p>
<p>等于-x或者-c选项的值，对于stap script -x process_ID，target()等于process_ID。
对于stap script -c command，target()等于command
- printf() 打印输出。格式化选项支持%s和%d</p>
</li>
</ul>
<p>target()示例：
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>probe syscall.* {
  if (pid() == target())
    printf(&quot;%s\n&quot;, name)
}
</code></pre></div></td></tr></table></div></p>
<h2 id="target-variables">Target Variables</h2>
<p>对于局部变量，我们可以根据变量名称直接访问</p>
<p>对于全局变量，我们可以使用@var访问：</p>
<blockquote>
<p>@var("varname", "/path/to/exe/or/lib")</p>
</blockquote>
<p>示例：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>stap -e &#39;probe kernel.function(&quot;vfs_read&quot;) {
           printf (&quot;current files_stat max_files: %d\n&quot;,
                   @var(&quot;files_stat@fs/file_table.c&quot;)-&gt;max_files);
           exit(); }&#39;
</code></pre></div></td></tr></table></div>
<p>我们可以列出可用探点和局部变量：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>stap -L &#39;process(&quot;a.out&quot;).function(&quot;*&quot;)&#39;
stap -L &#39;kernel.function(&quot;vfs_read&quot;)&#39;
stap -L &#39;kernel.function(&quot;sched_getaffinity&quot;)&#39;
</code></pre></div></td></tr></table></div>
<p>systemap内置几个变量：</p>
<ul>
<li>
<p>$$vars</p>
<p><span class="arithmatex">\(<span class="arithmatex">\(locals和\)</span>\)</span>parms组合体，等效于sprintf("parm1=%x ... parmN=%x var1=%x ... varN=%x", parm1, ..., parmN, var1, ..., varN)
- $$locals
局部变量 
$$parms
函数参数 
$$return
函数返回值</p>
</li>
</ul>
<p>对于指针类型，上面三个变量默认都打印指针值，如果要显示指针指向的值，可以在加上<span class="arithmatex">\(或\)</span>$后缀。</p>
<p>示例：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>stap -e &#39;probe kernel.function(&quot;vfs_read&quot;) {printf(&quot;%s\n&quot;, $$parms$$); exit(); }&#39;
</code></pre></div></td></tr></table></div>
<h2 id="systemtap-scripts_1">SystemTap Scripts基本操作</h2>
<h3 id="_6">注释</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code># it is comment
// it is comment
/* 
    it is comments
 */
</code></pre></div></td></tr></table></div>
<h3 id="ifelsewhilefor">if/else/while/for</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code>function if_expr() {
    i = 0
    if (i == 1)
        printf(&quot;[if] i = %d\n&quot;, i);
    else
        printf(&quot;[else] i = %d\n&quot;, i);
}

function while_expr() {
    i = 0;
    while (i != 2)
        printf(&quot;[while] i = %d\n&quot;, i++);
}

function for_expr() {
    for (i = 0; i &lt; 2; i++)
        printf(&quot;[for] i = %d\n&quot;, i);
}
</code></pre></div></td></tr></table></div>
<p>示例：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code>global countread, countnonread
probe kernel.function(&quot;vfs_read&quot;),kernel.function(&quot;vfs_write&quot;)
{
  if (probefunc()==&quot;vfs_read&quot;)
    countread ++
  else
    countnonread ++
}
probe timer.s(5) { exit() }
probe end
{
  printf(&quot;VFS reads total %d\n VFS writes total %d\n&quot;, countread, countnonread)
}
</code></pre></div></td></tr></table></div>
<h3 id="_7">比较操作</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>&gt;= # Greater than or equal to
&lt;= # Less than or equal to
!= # Is not equal to
</code></pre></div></td></tr></table></div>
<h3 id="_8">字符串</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>function str() {
    uid = uid();
    s_uid = sprint(uid);
    f_uid = &quot;a&quot; . s_uid
    printf(&quot;uid: %d-%s-%s\n&quot;, uid, s_uid, f_uid); // uid: 0-0-a0

    // exit();
}
</code></pre></div></td></tr></table></div>
<h3 id="_9">元组</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code>global t; // 声明元组
global tpl[400]; // 声明一个400容量的元组

t[&quot;a&quot;]++;  // t[&quot;a&quot;] 初始值默认为0, ++ 变成 1
t[&quot;a&quot;] = 4396; // 赋值为4396

tpl[&quot;a&quot;, pid()]++; // 两个元素
tpl[&quot;b&quot;, tid()]++;

 遍历（升序）, 最多遍历5次
foreach([key, value] in t+ limit 5)
    printf(&quot;%s: %d\n&quot;, key, value)
</code></pre></div></td></tr></table></div>
<h3 id="_10">聚集统计</h3>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>t[&quot;abc&quot;, 5487] &lt;&lt;&lt; 2
t[&quot;abc&quot;, 5487] &lt;&lt;&lt; 3
t[&quot;abc&quot;, 5487] &lt;&lt;&lt; 1

具体结构如下：
t[&quot;abc&quot;,5487] @count=3 @min=1 @max=3 @sum=6 @avg=2
</code></pre></div></td></tr></table></div>
示例：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code>global reads
probe vfs.read
{
  reads[execname(),pid()] &lt;&lt;&lt; 1
}
probe timer.s(3)
{
  foreach([var1,var2] in reads)
    printf(&quot;%s (%d) : %d \n&quot;, var1, var2, @count(reads[var1,var2]))
}
</code></pre></div></td></tr></table></div>
<h3 id="command-line-arguments">Command-Line Arguments</h3>
<p>我们可以通过$访问命令行参数：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>probe kernel.function(@1) { }
probe kernel.function(@1).return { }
</code></pre></div></td></tr></table></div>
<h2 id="_11">更多示例</h2>
<ul>
<li>探测go应用cpu pprof时候的系统调用</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>probe kernel.function(&quot;do_setitimer&quot;) {
    if(execname()==&quot;pprof&quot;) {
        printf(&quot;%s\n&quot;, $$params$$)
        printf(&quot;%d\n&quot;, $value-&gt;it_interval-&gt;tv_sec);
    }
}
</code></pre></div></td></tr></table></div>
<ul>
<li>open系统调用</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>probe kernel.function(&quot;sys_open&quot;).call {
    printf(&quot;%s call %s\n&quot;, execname(), ppfunc());
}

probe kernel.function(&quot;sys_open&quot;).return {
    printf(&quot;%s call %s return\n&quot;, execname(), ppfunc());
}
</code></pre></div></td></tr></table></div>
<ul>
<li>定时器</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>// 定时调用函数
probe timer.ms(1) {
    printf(&quot;now: %d\n&quot;, gettimeofday_s()); // 显示当前时间戳
}
</code></pre></div></td></tr></table></div>
<ul>
<li>cpu采样</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code>global bts;

probe timer.profile {
    if (pid() == 5291)
        bts[backtrace(), ubacktrace()] &lt;&lt;&lt; 1
}

probe timer.s(10) {
    foreach([k, u] in bts-) {
        print_stack(k);
        print_ustack(u);
        printf(&quot;\\t%d\\n&quot;, @count(bts[k, u]));
    }
    exit();
}
</code></pre></div></td></tr></table></div>
<ul>
<li>socket trace</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap

probe kernel.function(&quot;*@net/socket.c&quot;).call {
  printf (&quot;%s -&gt; %s\n&quot;, thread_indent(1), ppfunc())
}
probe kernel.function(&quot;*@net/socket.c&quot;).return {
  printf (&quot;%s &lt;- %s\n&quot;, thread_indent(-1), ppfunc())
}
</code></pre></div></td></tr></table></div>
<ul>
<li>tcp connections</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap

probe begin {
  printf(&quot;%6s %16s %6s %6s %16s\n&quot;,
         &quot;UID&quot;, &quot;CMD&quot;, &quot;PID&quot;, &quot;PORT&quot;, &quot;IP_SOURCE&quot;)
}

probe kernel.{function(&quot;tcp_accept&quot;),function(&quot;inet_csk_accept&quot;)}.return? {
  sock = $return
  if (sock != 0)
    printf(&quot;%6d %16s %6d %6d %16s\n&quot;, uid(), execname(), pid(),
           inet_get_local_port(sock), inet_get_ip_source(sock))
}
</code></pre></div></td></tr></table></div>
<ul>
<li>实现类似tcpdump功能</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap

// A TCP dump like example

probe begin, timer.s(1) {
  printf(&quot;-----------------------------------------------------------------\n&quot;)
  printf(&quot;       Source IP         Dest IP  SPort  DPort  U  A  P  R  S  F \n&quot;)
  printf(&quot;-----------------------------------------------------------------\n&quot;)
}

probe udp.recvmsg /* ,udp.sendmsg */ {
  printf(&quot; %15s %15s  %5d  %5d  UDP\n&quot;,
         saddr, daddr, sport, dport)
}

probe tcp.receive {
  printf(&quot; %15s %15s  %5d  %5d  %d  %d  %d  %d  %d  %d\n&quot;,
         saddr, daddr, sport, dport, urg, ack, psh, rst, syn, fin)
}
</code></pre></div></td></tr></table></div>
<ul>
<li>timestamp()函数实现</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap

global start

function timestamp:long() { return gettimeofday_us() - start }

function proc:string() { return sprintf(&quot;%d (%s)&quot;, pid(), execname()) }

probe begin { start = gettimeofday_us() }
</code></pre></div></td></tr></table></div>
<ul>
<li>I/O Monitoring (By Device)</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap

global device_of_interest

probe begin {
  /* The following is not the most efficient way to do this.
      One could directly put the result of usrdev2kerndev()
      into device_of_interest.  However, want to test out
      the other device functions */
  dev = usrdev2kerndev($1)
  device_of_interest = MKDEV(MAJOR(dev), MINOR(dev))
}

probe vfs.{write,read}
{
  if (dev == device_of_interest)
    printf (&quot;%s(%d) %s 0x%x\n&quot;,
            execname(), pid(), ppfunc(), dev)
}
</code></pre></div></td></tr></table></div>
<ul>
<li>Monitoring Changes to File Attributes</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap

global ATTR_MODE = 1

probe kernel.function(&quot;notify_change&quot;) {
  dev_nr = $dentry-&gt;d_inode-&gt;i_sb-&gt;s_dev
  inode_nr = $dentry-&gt;d_inode-&gt;i_ino

  if (dev_nr == MKDEV($1,$2) # major/minor device
      &amp;&amp; inode_nr == $3
      &amp;&amp; $attr-&gt;ia_valid &amp; ATTR_MODE)
    printf (&quot;%s(%d) %s 0x%x/%u %o %d\n&quot;,
      execname(), pid(), ppfunc(), dev_nr, inode_nr, $attr-&gt;ia_mode, uid())
}
</code></pre></div></td></tr></table></div>
<ul>
<li>Counting Function Calls Made</li>
</ul>
<p>使用方式：stap functioncallcount.stp "<em>@mm/</em>.c"</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code>#! /usr/bin/env stap
# The following line command will probe all the functions
# in kernel&#39;s memory management code:
#
# stap  functioncallcount.stp &quot;*@mm/*.c&quot;

probe kernel.function(@1).call {  # probe functions listed on commandline
  called[ppfunc()] &lt;&lt;&lt; 1  # add a count efficiently
}

global called

probe end {
  foreach (fn in called-)  # Sort by call count (in decreasing order)
  #       (fn+ in called)  # Sort by function name
    printf(&quot;%s %d\n&quot;, fn, @count(called[fn]))
  exit()
}
</code></pre></div></td></tr></table></div>
<h2 id="_12">学习资料</h2>
<ul>
<li><a href="https://blog.csdn.net/wangzuxi/article/details/42849053">SystemTap使用技巧</a></li>
<li><a href="http://myaut.github.io/dtrace-stap-book/index.html">Dynamic Tracing with DTrace &amp; SystemTap</a></li>
<li><a href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/index.html">SystemTap Beginners Guide</a></li>
<li><a href="https://github.com/calio/systemtap-cheat-sheet/blob/master/README.md">SystemTap Cheat Sheet</a></li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.instant"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.94c44541.min.js"></script>
      
    
  </body>
</html>